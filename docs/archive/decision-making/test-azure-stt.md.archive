# Speech-to-Text Testing Guide

**Project:** Lawh
**Version:** 2.0 (Updated with Google Cloud results)
**Last Updated:** 2026-02-03

---

## âœ… FINAL DECISION: Use Google Cloud STT

After comprehensive testing, **Google Cloud Speech-to-Text** was selected for MVP.

| Provider | Result | Decision |
|----------|--------|----------|
| **Google Cloud STT** | 60-70% accuracy, pure Arabic âœ… | **SELECTED** âœ… |
| Azure STT | 13-54%, mixed English/Arabic âŒ | Rejected |

**Why Google wins:** No English garbage, pure Arabic transcription, viable for fuzzy matching.

See detailed comparison: [azure-stt-quick-summary.md](./azure-stt-quick-summary.md)

---

## Overview (Azure Testing - Historical)

This guide documents the Azure Speech-to-Text testing process. While Azure was initially tested and showed excellent results with professional recitations, **it failed on live user recordings** with language detection issues.

**Azure Result:** NOT VIABLE for MVP
**Critical Issue:** Returns English text ("Who do we do", "Switch ing") on live recordings

---

## Prerequisites

- Azure account (sign up for free $200 credit)
- Dart/Flutter SDK installed
- Python 3.8+ (for audio conversion)
- ffmpeg installed (for audio format conversion)
- Sample Quranic recitation audio files

---

## Step 1: Set Up Azure Speech Service

### Create Azure Account

1. Go to https://portal.azure.com
2. Sign up for free account ($200 credit, no credit card required initially)
3. Verify email and complete registration

### Create Speech Service Resource

1. In Azure Portal, click "Create a resource"
2. Search for "Speech"
3. Click "Speech" by Microsoft
4. Click "Create"
5. Configure:
   - **Subscription:** Your subscription
   - **Resource Group:** Create new â†’ "lawh-resources"
   - **Region:** East US (or closest to your location)
   - **Name:** "lawh-speech-service"
   - **Pricing tier:** Free F0 (5 hours/month)
6. Click "Review + create" â†’ "Create"
7. Wait for deployment (~2 minutes)

### Get API Keys

1. Go to your Speech Service resource
2. Click "Keys and Endpoint" in left sidebar
3. Copy:
   - **KEY 1** (API Key)
   - **Location/Region** (e.g., "eastus")

**âš ï¸ Security:** Never commit API keys to git. Store in `.env` file.

---

## Step 2: Prepare Test Audio Files

### ğŸš€ Quick Setup (Recommended)

Use the automated setup script to download and convert all test audio files:

**Bash (macOS/Linux):**
```bash
./scripts/setup_test_audio.sh
```

**Python (Cross-platform):**
```bash
python3 scripts/setup_test_audio.py
```

This automatically:
- Downloads 17 test audio files from EveryAyah.com
- Converts MP3 to WAV format (16kHz, mono, 16-bit PCM)
- Creates test metadata file
- Takes ~2-3 minutes

See `test_audio/README.md` for details.

---

### Manual Setup (Alternative)

If you prefer manual setup or the scripts don't work:

#### Option A: Download Sample Recitations

```bash
# Create test audio directory
mkdir -p test_audio/samples

# Download Al-Fatihah (Surah 1) from Mishary Al-Afasy
curl -o test_audio/samples/001001.mp3 "https://everyayah.com/data/Alafasy_128kbps/001001.mp3"
curl -o test_audio/samples/001002.mp3 "https://everyayah.com/data/Alafasy_128kbps/001002.mp3"
curl -o test_audio/samples/001003.mp3 "https://everyayah.com/data/Alafasy_128kbps/001003.mp3"

# Download Ayat al-Kursi (2:255)
curl -o test_audio/samples/002255.mp3 "https://everyayah.com/data/Alafasy_128kbps/002255.mp3"

# Download from different reciters
curl -o test_audio/samples/sudais_001001.mp3 "https://everyayah.com/data/Abdurrahmaan_As-Sudais_192kbps/001001.mp3"
curl -o test_audio/samples/husary_001001.mp3 "https://everyayah.com/data/Husary_128kbps/001001.mp3"
```

#### Option B: Record Live Recitations

1. Open YouTube Quran recitation video
2. Use screen recording software (QuickTime on Mac, OBS on Windows/Linux)
3. Record 10-15 seconds of clear recitation
4. Save as .m4a or .mp4 file

#### Convert to Azure-Compatible Format

**Note:** The automated setup scripts handle this conversion automatically. Only follow these steps if you're doing manual setup.

Azure STT requires:
- **Format:** WAV
- **Sample Rate:** 16kHz or 8kHz
- **Channels:** Mono (1 channel)
- **Bit Depth:** 16-bit PCM

**Install ffmpeg:**

```bash
# macOS
brew install ffmpeg

# Ubuntu/Debian
sudo apt-get install ffmpeg

# Windows
choco install ffmpeg
```

**Convert audio files:**

```bash
# Convert all MP3 files to WAV
for file in test_audio/samples/*.mp3; do
  ffmpeg -i "$file" -ar 16000 -ac 1 -acodec pcm_s16le "${file%.mp3}.wav"
done

# Result: Creates .wav files next to each .mp3
```

**Verify conversion:**

```bash
# Check file properties
ffprobe test_audio/samples/001001.wav

# Should show:
# - Sample rate: 16000 Hz
# - Channels: 1 (mono)
# - Codec: pcm_s16le
```

---

## Step 3: Create Test Script

Create file: `scripts/test_azure_stt.dart`

```dart
#!/usr/bin/env dart
import 'dart:io';
import 'dart:typed_data';
import 'package:dio/dio.dart';

/// Azure STT Test Configuration
class AzureConfig {
  static const apiKey = 'YOUR_AZURE_API_KEY';  // Replace with your key
  static const region = 'eastus';  // Replace with your region
}

/// Test case definition
class TestCase {
  final String audioPath;
  final String expectedText;
  final String description;
  final int surahNumber;
  final int ayahNumber;

  TestCase({
    required this.audioPath,
    required this.expectedText,
    required this.description,
    this.surahNumber = 0,
    this.ayahNumber = 0,
  });
}

void main() async {
  print('=' * 70);
  print('Azure Speech-to-Text Accuracy Test for Lawh');
  print('=' * 70);
  print('');

  // Validate configuration
  if (AzureConfig.apiKey == 'YOUR_AZURE_API_KEY') {
    print('âŒ Error: Please set your Azure API key in the script');
    print('   Edit line 8: static const apiKey = \'YOUR_ACTUAL_KEY\';');
    exit(1);
  }

  // Define test cases
  final testCases = [
    TestCase(
      audioPath: 'test_audio/samples/001001.wav',
      expectedText: 'Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù',
      description: 'Al-Fatihah 1:1 - Clear recitation (Alafasy)',
      surahNumber: 1,
      ayahNumber: 1,
    ),
    TestCase(
      audioPath: 'test_audio/samples/001002.wav',
      expectedText: 'Ø§Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙÙ‘Ù‡Ù Ø±ÙØ¨ÙÙ‘ Ø§Ù„Ù’Ø¹ÙØ§Ù„ÙÙ…ÙÙŠÙ†Ù',
      description: 'Al-Fatihah 1:2 - Clear recitation (Alafasy)',
      surahNumber: 1,
      ayahNumber: 2,
    ),
    TestCase(
      audioPath: 'test_audio/samples/002255.wav',
      expectedText: 'Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ù„ÙØ§ Ø¥ÙÙ„ÙÙ°Ù‡Ù Ø¥ÙÙ„ÙÙ‘Ø§ Ù‡ÙÙˆÙ Ø§Ù„Ù’Ø­ÙÙŠÙÙ‘ Ø§Ù„Ù’Ù‚ÙÙŠÙÙ‘ÙˆÙ…Ù',
      description: 'Ayat al-Kursi (2:255) - Long verse',
      surahNumber: 2,
      ayahNumber: 255,
    ),
    TestCase(
      audioPath: 'test_audio/samples/sudais_001001.wav',
      expectedText: 'Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù',
      description: 'Al-Fatihah 1:1 - Different reciter (Sudais)',
      surahNumber: 1,
      ayahNumber: 1,
    ),
    // Add more test cases as needed
  ];

  // Run tests
  final results = await runTests(testCases);

  // Print summary
  printSummary(results);
}

/// Run all test cases
Future<List<TestResult>> runTests(List<TestCase> testCases) async {
  final results = <TestResult>[];

  for (var i = 0; i < testCases.length; i++) {
    final testCase = testCases[i];
    print('Test ${i + 1}/${testCases.length}: ${testCase.description}');
    print('â”€' * 70);

    try {
      // Check if file exists
      final file = File(testCase.audioPath);
      if (!await file.exists()) {
        print('âŒ File not found: ${testCase.audioPath}');
        print('');
        results.add(TestResult(
          testCase: testCase,
          success: false,
          errorMessage: 'File not found',
        ));
        continue;
      }

      // Load audio
      final audioBytes = await file.readAsBytes();
      print('  ğŸ“ Audio file: ${audioBytes.length} bytes');

      // Call Azure STT
      final transcription = await transcribeAudio(
        audioBytes,
        AzureConfig.apiKey,
        AzureConfig.region,
      );

      print('  ğŸ“ Expected: ${testCase.expectedText}');
      print('  ğŸ“ Got:      $transcription');

      // Calculate accuracy
      final accuracy = calculateAccuracy(testCase.expectedText, transcription);
      print('  ğŸ“Š Accuracy: ${(accuracy * 100).toStringAsFixed(1)}%');

      // Determine pass/fail
      final passed = accuracy >= 0.85;
      print(passed ? '  âœ… PASS' : '  âŒ FAIL');
      print('');

      results.add(TestResult(
        testCase: testCase,
        success: true,
        transcription: transcription,
        accuracy: accuracy,
      ));
    } catch (e) {
      print('  âŒ Error: $e');
      print('');
      results.add(TestResult(
        testCase: testCase,
        success: false,
        errorMessage: e.toString(),
      ));
    }
  }

  return results;
}

/// Call Azure STT API
Future<String> transcribeAudio(
  Uint8List audioData,
  String apiKey,
  String region,
) async {
  final dio = Dio();

  try {
    final response = await dio.post(
      'https://$region.stt.speech.microsoft.com/speech/recognition/conversation/cognitiveservices/v1',
      data: audioData,
      queryParameters: {
        'language': 'ar-SA',  // Arabic (Saudi Arabia)
        'format': 'simple',
      },
      options: Options(
        headers: {
          'Ocp-Apim-Subscription-Key': apiKey,
          'Content-Type': 'audio/wav',
        },
        receiveTimeout: const Duration(seconds: 30),
        sendTimeout: const Duration(seconds: 30),
      ),
    );

    return response.data['DisplayText'] ?? '';
  } on DioException catch (e) {
    if (e.response?.statusCode == 401 || e.response?.statusCode == 403) {
      throw Exception('Authentication failed - check your API key');
    }
    if (e.type == DioExceptionType.connectionTimeout) {
      throw Exception('Connection timeout - check your internet');
    }
    throw Exception('API error: ${e.message}');
  }
}

/// Calculate accuracy using character-level similarity
double calculateAccuracy(String expected, String actual) {
  // Remove all non-Arabic characters and diacritics
  final cleanExpected = cleanArabicText(expected);
  final cleanActual = cleanArabicText(actual);

  if (cleanExpected.isEmpty) return 0.0;

  // Calculate Levenshtein distance
  final distance = levenshteinDistance(cleanExpected, cleanActual);

  // Convert to accuracy percentage
  final maxLength = cleanExpected.length > cleanActual.length
      ? cleanExpected.length
      : cleanActual.length;

  return 1.0 - (distance / maxLength);
}

/// Remove diacritics and non-Arabic characters
String cleanArabicText(String text) {
  // Remove Arabic diacritics (harakat)
  final noDiacritics = text.replaceAll(RegExp(r'[\u064B-\u065F\u0670]'), '');

  // Keep only Arabic letters and spaces
  final arabicOnly = noDiacritics.replaceAll(RegExp(r'[^\u0600-\u06FF\s]'), '');

  // Normalize spaces
  return arabicOnly.trim().replaceAll(RegExp(r'\s+'), ' ');
}

/// Calculate Levenshtein distance between two strings
int levenshteinDistance(String s1, String s2) {
  final len1 = s1.length;
  final len2 = s2.length;

  final matrix = List.generate(
    len1 + 1,
    (i) => List.filled(len2 + 1, 0),
  );

  for (var i = 0; i <= len1; i++) {
    matrix[i][0] = i;
  }

  for (var j = 0; j <= len2; j++) {
    matrix[0][j] = j;
  }

  for (var i = 1; i <= len1; i++) {
    for (var j = 1; j <= len2; j++) {
      final cost = s1[i - 1] == s2[j - 1] ? 0 : 1;

      matrix[i][j] = [
        matrix[i - 1][j] + 1,      // deletion
        matrix[i][j - 1] + 1,      // insertion
        matrix[i - 1][j - 1] + cost, // substitution
      ].reduce((a, b) => a < b ? a : b);
    }
  }

  return matrix[len1][len2];
}

/// Print test summary
void printSummary(List<TestResult> results) {
  print('');
  print('=' * 70);
  print('Test Summary');
  print('=' * 70);
  print('');

  final successfulTests = results.where((r) => r.success).toList();
  final failedTests = results.where((r) => !r.success).toList();

  if (successfulTests.isNotEmpty) {
    final accuracies = successfulTests
        .where((r) => r.accuracy != null)
        .map((r) => r.accuracy!)
        .toList();

    final avgAccuracy = accuracies.isEmpty
        ? 0.0
        : accuracies.reduce((a, b) => a + b) / accuracies.length;

    final passCount = accuracies.where((a) => a >= 0.85).length;

    print('ğŸ“Š Results:');
    print('  â€¢ Total tests: ${results.length}');
    print('  â€¢ Successful: ${successfulTests.length}');
    print('  â€¢ Failed: ${failedTests.length}');
    print('  â€¢ Average accuracy: ${(avgAccuracy * 100).toStringAsFixed(1)}%');
    print('  â€¢ Tests passing 85% threshold: $passCount/${accuracies.length}');
    print('');

    // Decision
    if (avgAccuracy >= 0.85 && passCount >= accuracies.length * 0.8) {
      print('âœ… RECOMMENDATION: Proceed with Azure STT');
      print('   Accuracy meets MVP requirements (â‰¥85%)');
    } else if (avgAccuracy >= 0.70) {
      print('âš ï¸  RECOMMENDATION: Consider improvements or alternatives');
      print('   Accuracy is moderate (70-84%)');
      print('   Options:');
      print('   1. Test with more diverse recitation samples');
      print('   2. Implement audio preprocessing (noise reduction)');
      print('   3. Evaluate Google Cloud STT as alternative');
    } else {
      print('âŒ RECOMMENDATION: Do not proceed with Azure STT');
      print('   Accuracy too low (<70%)');
      print('   Actions:');
      print('   1. Test Google Cloud Speech-to-Text');
      print('   2. Consider hybrid approach (multiple STT providers)');
      print('   3. Reevaluate technical feasibility');
    }
  } else {
    print('âŒ All tests failed');
    print('   Check:');
    print('   1. API key is correct');
    print('   2. Audio files are in correct format (16kHz WAV mono)');
    print('   3. Internet connection is stable');
  }

  print('');
  print('=' * 70);
}

/// Test result data class
class TestResult {
  final TestCase testCase;
  final bool success;
  final String? transcription;
  final double? accuracy;
  final String? errorMessage;

  TestResult({
    required this.testCase,
    required this.success,
    this.transcription,
    this.accuracy,
    this.errorMessage,
  });
}
```

---

## Step 4: Create Comprehensive Accuracy Testing Script

Create file: `scripts/accuracy_test_suite.dart`

```dart
#!/usr/bin/env dart
import 'dart:io';
import 'dart:convert';
import 'dart:typed_data';
import 'package:dio/dio.dart';

/// Comprehensive accuracy testing suite for Azure STT
void main(List<String> args) async {
  print('=' * 80);
  print('Lawh - Comprehensive Azure STT Accuracy Test Suite');
  print('=' * 80);
  print('');

  // Check for API key argument
  if (args.isEmpty || args[0] == 'YOUR_API_KEY') {
    print('Usage: dart scripts/accuracy_test_suite.dart <AZURE_API_KEY> [region]');
    print('Example: dart scripts/accuracy_test_suite.dart abc123xyz eastus');
    exit(1);
  }

  final apiKey = args[0];
  final region = args.length > 1 ? args[1] : 'eastus';

  // Run comprehensive test suite
  final suite = AccuracyTestSuite(apiKey, region);
  await suite.runAllTests();
}

class AccuracyTestSuite {
  final String apiKey;
  final String region;
  final List<TestResult> results = [];

  AccuracyTestSuite(this.apiKey, this.region);

  Future<void> runAllTests() async {
    print('Configuration:');
    print('  API Key: ${apiKey.substring(0, 8)}...');
    print('  Region: $region');
    print('');

    // Test categories
    await testCategory1_ClearRecitations();
    await testCategory2_DifferentReciters();
    await testCategory3_LongVerses();
    await testCategory4_ShortVerses();
    await testCategory5_NoisyEnvironments();

    // Generate comprehensive report
    generateReport();
  }

  /// Category 1: Clear recitations from famous reciter
  Future<void> testCategory1_ClearRecitations() async {
    print('â”€' * 80);
    print('Category 1: Clear Recitations (Baseline)');
    print('â”€' * 80);
    print('');

    final tests = [
      ('test_audio/samples/001001.wav', 'Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù', '1:1'),
      ('test_audio/samples/001002.wav', 'Ø§Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙÙ‘Ù‡Ù Ø±ÙØ¨ÙÙ‘ Ø§Ù„Ù’Ø¹ÙØ§Ù„ÙÙ…ÙÙŠÙ†Ù', '1:2'),
      ('test_audio/samples/001003.wav', 'Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù', '1:3'),
      ('test_audio/samples/001004.wav', 'Ù…ÙØ§Ù„ÙÙƒÙ ÙŠÙÙˆÙ’Ù…Ù Ø§Ù„Ø¯ÙÙ‘ÙŠÙ†Ù', '1:4'),
    ];

    for (final test in tests) {
      await runSingleTest(test.$1, test.$2, test.$3, 'Clear - Alafasy');
    }
  }

  /// Category 2: Different reciters (same verses)
  Future<void> testCategory2_DifferentReciters() async {
    print('â”€' * 80);
    print('Category 2: Different Reciters');
    print('â”€' * 80);
    print('');

    final tests = [
      ('test_audio/samples/sudais_001001.wav', 'Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù', 'Sudais'),
      ('test_audio/samples/husary_001001.wav', 'Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù', 'Husary'),
      ('test_audio/samples/minshawi_001001.wav', 'Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù', 'Minshawi'),
    ];

    for (final test in tests) {
      await runSingleTest(test.$1, test.$2, '1:1', test.$3);
    }
  }

  /// Category 3: Long verses
  Future<void> testCategory3_LongVerses() async {
    print('â”€' * 80);
    print('Category 3: Long Verses');
    print('â”€' * 80);
    print('');

    final tests = [
      (
        'test_audio/samples/002255.wav',
        'Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ù„ÙØ§ Ø¥ÙÙ„ÙÙ°Ù‡Ù Ø¥ÙÙ„ÙÙ‘Ø§ Ù‡ÙÙˆÙ Ø§Ù„Ù’Ø­ÙÙŠÙÙ‘ Ø§Ù„Ù’Ù‚ÙÙŠÙÙ‘ÙˆÙ…Ù Ù„ÙØ§ ØªÙØ£Ù’Ø®ÙØ°ÙÙ‡Ù Ø³ÙÙ†ÙØ©ÙŒ ÙˆÙÙ„ÙØ§ Ù†ÙÙˆÙ’Ù…ÙŒ',
        '2:255 (Ayat al-Kursi)'
      ),
      // Add more long verses
    ];

    for (final test in tests) {
      await runSingleTest(test.$1, test.$2, test.$3, 'Long verse');
    }
  }

  /// Category 4: Short verses
  Future<void> testCategory4_ShortVerses() async {
    print('â”€' * 80);
    print('Category 4: Short Verses');
    print('â”€' * 80);
    print('');

    final tests = [
      ('test_audio/samples/103001.wav', 'ÙˆÙØ§Ù„Ù’Ø¹ÙØµÙ’Ø±Ù', '103:1'),
      ('test_audio/samples/108001.wav', 'Ø¥ÙÙ†ÙÙ‘Ø§ Ø£ÙØ¹Ù’Ø·ÙÙŠÙ’Ù†ÙØ§ÙƒÙ Ø§Ù„Ù’ÙƒÙÙˆÙ’Ø«ÙØ±Ù', '108:1'),
    ];

    for (final test in tests) {
      await runSingleTest(test.$1, test.$2, test.$3, 'Short verse');
    }
  }

  /// Category 5: Noisy environments (if available)
  Future<void> testCategory5_NoisyEnvironments() async {
    print('â”€' * 80);
    print('Category 5: Noisy Environments');
    print('â”€' * 80);
    print('');

    final tests = [
      ('test_audio/noisy/mosque_001001.wav', 'Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù', 'Mosque echo'),
      ('test_audio/noisy/outdoor_001001.wav', 'Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù', 'Outdoor'),
    ];

    for (final test in tests) {
      if (await File(test.$1).exists()) {
        await runSingleTest(test.$1, test.$2, test.$3, 'Noisy');
      }
    }
  }

  /// Run single test
  Future<void> runSingleTest(
    String audioPath,
    String expected,
    String reference,
    String category,
  ) async {
    try {
      final file = File(audioPath);
      if (!await file.exists()) {
        print('âŠ˜ Skipped: $reference ($category) - File not found');
        return;
      }

      final audioBytes = await file.readAsBytes();
      final transcription = await transcribeAudio(audioBytes);

      final accuracy = calculateAccuracy(expected, transcription);
      final passed = accuracy >= 0.85;

      print('${passed ? "âœ“" : "âœ—"} $reference ($category): ${(accuracy * 100).toStringAsFixed(1)}%');

      results.add(TestResult(
        reference: reference,
        category: category,
        expected: expected,
        actual: transcription,
        accuracy: accuracy,
        passed: passed,
      ));
    } catch (e) {
      print('âœ— $reference ($category): Error - $e');
      results.add(TestResult(
        reference: reference,
        category: category,
        expected: expected,
        actual: '',
        accuracy: 0.0,
        passed: false,
        error: e.toString(),
      ));
    }
  }

  /// Transcribe audio with Azure STT
  Future<String> transcribeAudio(Uint8List audioData) async {
    final dio = Dio();

    final response = await dio.post(
      'https://$region.stt.speech.microsoft.com/speech/recognition/conversation/cognitiveservices/v1',
      data: audioData,
      queryParameters: {
        'language': 'ar-SA',
        'format': 'simple',
      },
      options: Options(
        headers: {
          'Ocp-Apim-Subscription-Key': apiKey,
          'Content-Type': 'audio/wav',
        },
        receiveTimeout: const Duration(seconds: 30),
      ),
    );

    return response.data['DisplayText'] ?? '';
  }

  /// Calculate accuracy
  double calculateAccuracy(String expected, String actual) {
    final cleanExpected = cleanArabicText(expected);
    final cleanActual = cleanArabicText(actual);

    if (cleanExpected.isEmpty) return 0.0;

    final distance = levenshteinDistance(cleanExpected, cleanActual);
    final maxLength = cleanExpected.length > cleanActual.length
        ? cleanExpected.length
        : cleanActual.length;

    return 1.0 - (distance / maxLength);
  }

  String cleanArabicText(String text) {
    final noDiacritics = text.replaceAll(RegExp(r'[\u064B-\u065F\u0670]'), '');
    final arabicOnly = noDiacritics.replaceAll(RegExp(r'[^\u0600-\u06FF\s]'), '');
    return arabicOnly.trim().replaceAll(RegExp(r'\s+'), ' ');
  }

  int levenshteinDistance(String s1, String s2) {
    final len1 = s1.length;
    final len2 = s2.length;
    final matrix = List.generate(len1 + 1, (i) => List.filled(len2 + 1, 0));

    for (var i = 0; i <= len1; i++) matrix[i][0] = i;
    for (var j = 0; j <= len2; j++) matrix[0][j] = j;

    for (var i = 1; i <= len1; i++) {
      for (var j = 1; j <= len2; j++) {
        final cost = s1[i - 1] == s2[j - 1] ? 0 : 1;
        matrix[i][j] = [
          matrix[i - 1][j] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j - 1] + cost,
        ].reduce((a, b) => a < b ? a : b);
      }
    }

    return matrix[len1][len2];
  }

  /// Generate comprehensive report
  void generateReport() {
    print('');
    print('=' * 80);
    print('Comprehensive Test Report');
    print('=' * 80);
    print('');

    // Overall statistics
    final totalTests = results.length;
    final passedTests = results.where((r) => r.passed).length;
    final averageAccuracy = results.isEmpty
        ? 0.0
        : results.map((r) => r.accuracy).reduce((a, b) => a + b) / totalTests;

    print('Overall Statistics:');
    print('  Total Tests: $totalTests');
    print('  Passed (â‰¥85%): $passedTests');
    print('  Failed (<85%): ${totalTests - passedTests}');
    print('  Pass Rate: ${((passedTests / totalTests) * 100).toStringAsFixed(1)}%');
    print('  Average Accuracy: ${(averageAccuracy * 100).toStringAsFixed(1)}%');
    print('');

    // Category breakdown
    print('Category Breakdown:');
    final categories = results.map((r) => r.category).toSet();
    for (final category in categories) {
      final categoryResults = results.where((r) => r.category == category).toList();
      final categoryAvg = categoryResults.isEmpty
          ? 0.0
          : categoryResults.map((r) => r.accuracy).reduce((a, b) => a + b) /
              categoryResults.length;

      print('  $category: ${(categoryAvg * 100).toStringAsFixed(1)}% '
          '(${categoryResults.where((r) => r.passed).length}/${categoryResults.length} passed)');
    }
    print('');

    // Decision matrix
    print('=' * 80);
    if (averageAccuracy >= 0.85 && (passedTests / totalTests) >= 0.8) {
      print('âœ… DECISION: PROCEED WITH AZURE STT');
      print('');
      print('Rationale:');
      print('  â€¢ Average accuracy ${(averageAccuracy * 100).toStringAsFixed(1)}% meets 85% threshold');
      print('  â€¢ ${((passedTests / totalTests) * 100).toStringAsFixed(0)}% of tests passed');
      print('  â€¢ Suitable for MVP deployment');
      print('');
      print('Next Steps:');
      print('  1. Implement Azure STT integration in app');
      print('  2. Build fuzzy matching algorithm');
      print('  3. Test with real user recordings');
    } else if (averageAccuracy >= 0.70) {
      print('âš ï¸  DECISION: CONDITIONAL PROCEED');
      print('');
      print('Rationale:');
      print('  â€¢ Accuracy ${(averageAccuracy * 100).toStringAsFixed(1)}% is moderate (70-84%)');
      print('  â€¢ May work for MVP with limitations');
      print('');
      print('Required Actions Before Proceeding:');
      print('  1. Test with more diverse audio samples (10+ more tests)');
      print('  2. Implement audio preprocessing (noise reduction)');
      print('  3. Evaluate Google Cloud STT as backup');
      print('  4. Set user expectations (show confidence scores)');
    } else {
      print('âŒ DECISION: DO NOT PROCEED WITH AZURE STT');
      print('');
      print('Rationale:');
      print('  â€¢ Accuracy ${(averageAccuracy * 100).toStringAsFixed(1)}% too low (<70%)');
      print('  â€¢ Will not meet MVP success criteria');
      print('');
      print('Alternative Actions:');
      print('  1. Test Google Cloud Speech-to-Text');
      print('  2. Test AssemblyAI or Speechmatics');
      print('  3. Consider audio fingerprinting approach');
      print('  4. Reevaluate technical feasibility of MVP');
    }
    print('=' * 80);

    // Save detailed report to file
    saveDetailedReport();
  }

  /// Save detailed report to JSON file
  void saveDetailedReport() {
    final report = {
      'timestamp': DateTime.now().toIso8601String(),
      'summary': {
        'total_tests': results.length,
        'passed': results.where((r) => r.passed).length,
        'average_accuracy': results.isEmpty
            ? 0.0
            : results.map((r) => r.accuracy).reduce((a, b) => a + b) /
                results.length,
      },
      'tests': results.map((r) => r.toJson()).toList(),
    };

    final file = File('test_results/azure_stt_accuracy_report.json');
    file.parent.createSync(recursive: true);
    file.writeAsStringSync(jsonEncode(report));

    print('');
    print('ğŸ“„ Detailed report saved to: test_results/azure_stt_accuracy_report.json');
  }
}

class TestResult {
  final String reference;
  final String category;
  final String expected;
  final String actual;
  final double accuracy;
  final bool passed;
  final String? error;

  TestResult({
    required this.reference,
    required this.category,
    required this.expected,
    required this.actual,
    required this.accuracy,
    required this.passed,
    this.error,
  });

  Map<String, dynamic> toJson() => {
        'reference': reference,
        'category': category,
        'expected': expected,
        'actual': actual,
        'accuracy': accuracy,
        'passed': passed,
        if (error != null) 'error': error,
      };
}
```

---

## Step 5: Run Tests

### Basic Test

```bash
# Install dependencies
dart pub add dio

# Run basic test
dart scripts/test_azure_stt.dart
```

### Comprehensive Accuracy Test

```bash
# Run full accuracy test suite
dart scripts/accuracy_test_suite.dart YOUR_AZURE_API_KEY eastus

# View results
cat test_results/azure_stt_accuracy_report.json
```

---

## Step 6: Interpret Results

### Success Criteria

âœ… **Proceed with Azure STT if:**
- Average accuracy â‰¥ 85%
- Pass rate â‰¥ 80% (80% of tests meet 85% threshold)
- Works across different reciters
- Handles both short and long verses

âš ï¸ **Conditional proceed if:**
- Average accuracy 70-84%
- Works for some categories but not others
- **Action:** Increase test sample size, implement preprocessing

âŒ **Do not proceed if:**
- Average accuracy < 70%
- High failure rate across all categories
- **Action:** Test alternative STT providers (Google, AssemblyAI)

---

## Troubleshooting

### "Authentication failed"
- Verify API key is correct (copy from Azure portal)
- Check key hasn't expired
- Ensure Speech Service is active

### "Empty transcription"
- Check audio format (must be 16kHz WAV mono)
- Verify audio contains Arabic speech
- Test with known good sample first

### "Connection timeout"
- Check internet connection
- Increase timeout in script
- Try different Azure region

### "Low accuracy across all tests"
- Verify expected text is correct (check with Quran.com)
- Ensure audio quality is good
- Try different reciter samples

---

## Next Steps

After testing:

1. **If accuracy â‰¥ 85%**:
   - Document results
   - Proceed with full implementation
   - Implement fuzzy matching algorithm

2. **If accuracy 70-84%**:
   - Test more samples (20+ tests)
   - Research audio preprocessing techniques
   - Evaluate Google Cloud STT

3. **If accuracy < 70%**:
   - Test alternative providers immediately
   - Consider pivot to audio fingerprinting
   - Reevaluate MVP feasibility

---

## Test Results (February 3, 2026)

**See comprehensive test results:**
- ğŸ“Š **Full Report:** [azure-stt-test-results.md](./azure-stt-test-results.md)
- ğŸ“ **Quick Summary:** [azure-stt-quick-summary.md](./azure-stt-quick-summary.md)

**Key Findings:**
- âœ… Professional recitations: 93-100% accuracy
- âœ… Different reciters: 100% accuracy
- âŒ Live user recordings: 54% accuracy (needs audio preprocessing)
- **Decision:** CONDITIONAL PROCEED with audio preprocessing

---

**Document Status:** âœ… Complete
**Last Updated:** 2026-02-03
